---
- name: Initialize First Master Node
  hosts: masters
  become: yes
  tasks:

    - name: Gather facts
      ansible.builtin.setup:

    - name: Reset kubeadm (clean previous state)
      command: kubeadm reset -f
      register: kubeadm_reset
      failed_when: false
      changed_when: false
      
    - name: Display kubeadm reset output
      debug:
        msg: "{{ kubeadm_reset.stdout_lines }}"
      when: kubeadm_reset.stdout_lines is defined

    - name: Initialize Kubernetes control plane
      command: >
        kubeadm init
        --pod-network-cidr=192.168.0.0/16
        --apiserver-advertise-address=192.168.56.10
        --control-plane-endpoint=192.168.56.10
      args:
        creates: /etc/kubernetes/admin.conf

    - name: Ensure .kube directory exists for root
      file:
        path: /root/.kube
        state: directory
        owner: root
        group: root
        mode: '0700'

    - name: Copy admin.conf to root .kube/config
      copy:
        src: /etc/kubernetes/admin.conf
        dest: /root/.kube/config
        owner: root
        group: root
        mode: '0600'
        remote_src: yes

    - name: Ensure .kube directory exists for vagrant user
      file:
        path: /home/vagrant/.kube
        state: directory
        owner: vagrant
        group: vagrant
        mode: '0700'

    - name: Copy admin.conf to vagrant user .kube/config
      copy:
        src: /etc/kubernetes/admin.conf
        dest: /home/vagrant/.kube/config
        owner: vagrant
        group: vagrant
        mode: '0600'
        remote_src: yes

    - name: Set KUBECONFIG environment variable for vagrant user
      lineinfile:
        path: /home/vagrant/.bashrc
        line: 'export KUBECONFIG=$HOME/.kube/config'
        state: present
        create: yes

    - name: Ensure kubelet is enabled and started
      systemd:
        name: kubelet
        enabled: yes
        state: started

